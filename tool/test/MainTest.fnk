;;; Tests for main function

(:require Finkel.Core)

(defmodule MainTest
  (export mainTests)
  (import-when [compile]
    (Finkel.Prelude))
  (import
   ;; base
   (Control.Exception (bracket))
   (Control.Monad.IO.Class ((MonadIO ..)))
   (Data.Version (showVersion))
   (System.Environment (getEnvironment setEnv withArgs))

   ;; finkel-core
   (qualified Paths_finkel_core)

   ;; hspec
   (Test.Hspec)

   ;; Internal
   (Finkel.Tool.CLI)
   (Finkel.Tool.Help)
   (Finkel.Tool.Main)
   (Finkel.Tool.Repl)
   (Finkel.Tool.Version)
   (Finkel.Tool.Version.Commit)
   (TestAux)))

;;; Tests

(defn (:: mainTests Spec)
  (do (let ((= d describe)
            (= main' args
              (withArgs args main))))
      (d "main with no argument"
         (it "should show usage"
           (shouldReturn (main' []) ())))
      (d "main with invalid command"
         (it "should show usage"
           (shouldReturn (main' ["no-such-command"]) ())))
      (d "main with help command"
         (do (it "should show usage"
               (shouldReturn (main' ["help"]) ()))
             (it "should show help of repl command"
               (shouldReturn (main' ["help" "repl"]) ()))
             (it "should show help of make command"
               (shouldReturn (main' ["help" "make"]) ()))))
      (d "main with make command"
         (it "should show help on --fnk-help"
           (shouldReturn (main' ["make" "--fnk-help"]) ())))
      (d "main with repl command"
         (it "should show help on --help"
           (shouldReturn (main' ["repl" "--help"]) ())))
      (d "main with version command"
         (it "should show version message by default"
           (shouldReturn (main' ["version"]) ())))
      helpTests
      replTests
      versionTests))

(defn (:: helpTests Spec)
  (describe "help command"
    (it "should contain command names in usage message"
      (do (<- (, _ lns) (runTestIO (show-usage commands) []))
          (let ((= messageShouldContain
                  (shouldContain (unlines (tst-outputs lns))))))
          (messageShouldContain "repl")
          (messageShouldContain "make")
          (messageShouldContain "version")))))

(defn (:: replTests Spec)
  (describe "repl command"
    (do (let ((= repl args
                (fmap (. unlines (. tst-outputs snd))
                      (liftIO (runTestIO (replMain args) []))))))
        (it "should complain unrecognized option"
          (do (<- msg (repl ["--no-such-option"]))
              (shouldContain msg "--no-such-option"))))))

(defn (:: versionTests Spec)
  (describe "version command"
    (do (let ((= version args
                (fmap (. unlines (. tst-outputs snd))
                      (liftIO (runTestIO (versionMain args) []))))))
        (it "should not throw exceptions with git command"
          (do (<- commit-id (liftIO get-git-commit))
              (shouldReturn (print commit-id) ())))
        (it "should not throw exception when git command is not found"
          (cond-expand
            ;; The use of `setEnv' may have problem under Windows ...
            [(/= :os "mingw32")
             (do (<- mb-commit-id (liftIO (with-tmp-env [(, "PATH" ".")]
                                            get-git-commit)))
                 (shouldBe mb-commit-id Nothing))]
            [otherwise
             (pendingWith "problem with `setEnv'")]))
        (it "should show ghc version in default message"
          (do (<- msg (version []))
              (shouldContain msg "ghc")))
        (it "should show \"--help\" in help message"
          (do (<- msg (version ["--help"]))
              (shouldContain msg "--help")))
        (it "should show numeric version with \"--numeric\" option"
          (do (<- msg (version ["--numeric"]))
              (shouldContain msg (showVersion Paths_finkel_core.version))))
        (it "should complain unrecognized option"
          (do (<- msg (version ["--no-such-option"]))
              (shouldContain msg "--no-such-option"))))))

(defn (:: with-tmp-env (-> [(, String String)] (IO a) (IO a)))
  [envvars act]
  (bracket getEnvironment
           (mapM_ (uncurry setEnv))
           (const (>> (mapM_ (uncurry setEnv) envvars) act))))
